---
- name: "Test mimir role installation."
  block:
    - name: "Import mimir role."
      ansible.builtin.import_role:
        name: calopsys.observability.mimir
      vars:
        calopsys_mimir_config_template: standalone_s3.yml.j2
        calopsys_mimir_standalone_s3_endpoint: "http://localhost:9000"
        calopsys_mimir_standalone_s3_bucket: "mimir"
        calopsys_mimir_standalone_s3_accesskey: "test"
        calopsys_mimir_standalone_s3_secretkey: "test"

    - name: "Verify mimir package is installed."
      ansible.builtin.package_facts:
        manager: auto
      no_log: true

    - name: "Assert mimir package is installed."
      ansible.builtin.assert:
        that:
          - "'mimir' in ansible_facts.packages"
        fail_msg: "mimir package is not installed."
        success_msg: "mimir package is installed."

    - name: "Verify grafana apt repository file exists."
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d/grafana.sources
      register: repo_stat

    - name: "Assert grafana repository is configured."
      ansible.builtin.assert:
        that:
          - repo_stat.stat.exists
        fail_msg: "Grafana apt repository is not configured."
        success_msg: "Grafana apt repository is configured."

- name: "Test mimir role configuration."
  block:
    - name: "Verify mimir config directory exists."
      ansible.builtin.stat:
        path: /etc/mimir
      register: config_dir_stat

    - name: "Assert config directory exists."
      ansible.builtin.assert:
        that:
          - config_dir_stat.stat.exists
          - config_dir_stat.stat.isdir
        fail_msg: "Mimir config directory does not exist."
        success_msg: "Mimir config directory exists."

    - name: "Verify mimir config file exists."
      ansible.builtin.stat:
        path: /etc/mimir/config.yml
      register: config_file_stat

    - name: "Assert config file exists."
      ansible.builtin.assert:
        that:
          - config_file_stat.stat.exists
        fail_msg: "Mimir config file does not exist."
        success_msg: "Mimir config file exists."

- name: "Test mimir role service."
  block:
    - name: "Get service facts."
      ansible.builtin.service_facts:
      no_log: true

    - name: "Assert mimir service is enabled."
      ansible.builtin.assert:
        that:
          - "'mimir' in ansible_facts.services"
          - "ansible_facts.services['mimir'].status == 'enabled'"
        fail_msg: "mimir service is not enabled."
        success_msg: "mimir service is enabled."

- name: "Test mimir role idempotency."
  block:
    - name: "Import mimir role again for idempotency check."
      ansible.builtin.import_role:
        name: calopsys.observability.mimir
      vars:
        calopsys_mimir_config_template: standalone_s3.yml.j2
        calopsys_mimir_standalone_s3_endpoint: "http://localhost:9000"
        calopsys_mimir_standalone_s3_bucket: "mimir"
        calopsys_mimir_standalone_s3_accesskey: "test"
        calopsys_mimir_standalone_s3_secretkey: "test"
      register: idempotency_result

    - name: "Assert role is idempotent."
      ansible.builtin.assert:
        that:
          - not idempotency_result.changed
        fail_msg: "Role is not idempotent."
        success_msg: "Role is idempotent."
